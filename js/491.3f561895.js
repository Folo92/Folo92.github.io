"use strict";(self["webpackChunkyun_admin"]=self["webpackChunkyun_admin"]||[]).push([[491],{6814:function(e,t,i){i.d(t,{C:function(){return s},h:function(){return o}});i(6699),i(1703);let a;function o(e="db_default",t=1,i){return new Promise(((o,s)=>{const n=window.indexedDB.open(e,t);n.onsuccess=function(e){a=e.target.result,o(e.target.result)},n.onupgradeneeded=function(e){a=e.target.result,i&&i.forEach((e=>{if(!a.objectStoreNames.contains(e.storeName)){const t=a.createObjectStore(e.storeName,{keyPath:e.idName,autoIncrement:!0});t.createIndex(e.indexName,e.propName,{unique:e.unique})}}))},n.onerror=function(e){s(e)}}))}async function s(e,t,i){const o=["add","get","getAll","put","delete","getByIndex"];if(!o.includes(t))throw new Error(`操作类型错误, 仅支持: ${o.toString()} 方法`);const s=["get","getAll","getByIndex"].includes(t)?"readonly":"readwrite",n=a.transaction(e,s).objectStore(e);return new Promise(((a,o)=>{let s;switch(t){case"add":s=n.add(i);break;case"get":s=n.get(i);break;case"getAll":s=n.getAll(i);break;case"put":s=n.put(i);break;case"delete":s=n.delete(i);break;case"getByIndex":{const e=n.index(i.name);s=e.get(i.value);break}}alert(e+","+t+","+JSON.stringify(i)+", request,",JSON.stringify(s)),s.onsuccess=e=>{alert("success, ",e.target.result),a(e.target.result)},s.onerror=e=>{o(e)}}))}window.indexedDB||window.alert("你的浏览器不支持IndexedDB的稳定版本。书籍缓存功能将不可用。")},7281:function(e,t,i){i.r(t),i.d(t,{default:function(){return W}});var a=i(3396),o=i(7139),s=i(9242);const n={class:"app-container"},l={style:{width:"800px",margin:"0 auto"}},r=(0,a._)("div",{class:"el-upload__text"},[(0,a.Uk)("Drop file here or "),(0,a._)("em",null,"click to upload")],-1),d=(0,a._)("div",{class:"el-upload__tip"},"txt files with a size less than 50mb",-1),c=(0,a._)("br",null,null,-1),h=(0,a._)("img",{src:"https://img.fevte.com/data/attachment/portal/201407/31/112644t4u445t4ttch57mu.jpg?x-oss-process=image/auto-orient,1/quality,q_80",class:"image"},null,-1),p={style:{padding:"14px"}},u=["onClick"],g={class:"bottom"},k=(0,a.Uk)("目录"),b=(0,a.Uk)("删除"),m=(0,a._)("br",null,null,-1),f={style:{color:"#4490f1","font-size":"16px"}},w={class:"flex items-center"},x={style:{color:"var(--el-text-color-regular)","font-size":"16px"}},y=(0,a.Uk)("   "),I=(0,a.Uk)("   "),_=(0,a._)("br",null,null,-1),C=["onClick"],L=(0,a.Uk)(" 阅读 "),N={class:"filter-container"};function v(e,t,i,v,A,z){const B=(0,a.up)("upload-filled"),S=(0,a.up)("el-icon"),P=(0,a.up)("el-upload"),R=(0,a.up)("el-button"),W=(0,a.up)("el-card"),$=(0,a.up)("el-col"),U=(0,a.up)("el-row"),D=(0,a.up)("el-page-header"),T=(0,a.up)("el-table-column"),j=(0,a.up)("el-table"),q=(0,a.up)("pagination"),F=(0,a.up)("YunReader");return(0,a.wg)(),(0,a.iD)("div",n,[(0,a.wy)((0,a._)("div",l,[(0,a.Wm)(P,{modelValue:A.fileList,"onUpdate:modelValue":t[0]||(t[0]=e=>A.fileList=e),ref:"upload",class:"upload-demo",action:"#","auto-upload":!1,drag:"","on-change":z.onChange},{tip:(0,a.w5)((()=>[d])),default:(0,a.w5)((()=>[(0,a.Wm)(S,{class:"el-icon--upload"},{default:(0,a.w5)((()=>[(0,a.Wm)(B)])),_:1}),r])),_:1},8,["modelValue","on-change"]),c,(0,a.Wm)(U,{gutter:30},{default:(0,a.w5)((()=>[((0,a.wg)(!0),(0,a.iD)(a.HY,null,(0,a.Ko)(A.bookList,((e,t)=>((0,a.wg)(),(0,a.j4)($,{key:e,span:6,style:{"margin-bottom":"30px"}},{default:(0,a.w5)((()=>[(0,a.Wm)(W,{"body-style":{padding:"0px",height:"240px"}},{default:(0,a.w5)((()=>[h,(0,a._)("div",p,[(0,a._)("div",{class:"link-type",style:{"font-size":"14px",height:"50px"},onClick:t=>z.readBook(e)},(0,o.zw)(e.bookName),9,u),(0,a._)("div",g,[(0,a.Wm)(R,{text:"",class:"button link-type",onClick:t=>z.showCatalog(e)},{default:(0,a.w5)((()=>[k])),_:2},1032,["onClick"]),(0,a.Wm)(R,{text:"",class:"button link-type",onClick:i=>z.deleteBook(e,t)},{default:(0,a.w5)((()=>[b])),_:2},1032,["onClick"])])])])),_:2},1024)])),_:2},1024)))),128))])),_:1}),m,(0,a.wy)((0,a._)("div",null,[(0,a.Wm)(D,{icon:A.isAsc?"SortUp":"SortDown",onBack:z.sortChange,style:{color:"#4490f1","font-size":"16px"}},{title:(0,a.w5)((()=>[(0,a._)("span",f,(0,o.zw)(A.isAsc?"升序":"降序"),1)])),content:(0,a.w5)((()=>[(0,a._)("div",w,[(0,a._)("span",x,(0,o.zw)(A.bookName),1),y,(0,a.wy)((0,a._)("span",{class:"link-type",style:{"font-size":"14px"},onClick:t[1]||(t[1]=e=>z.readArticle())},"继续阅读",512),[[s.F8,""!=A.bookName]]),I,(0,a._)("span",{class:"link-type",style:{"font-size":"14px",right:"0"},onClick:t[2]||(t[2]=e=>A.catalogVisible=!1)},"关闭")])])),_:1},8,["icon","onBack"]),_,((0,a.wg)(),(0,a.j4)(j,{key:A.tableKey,data:A.list,border:"","table-layout":"fixed","max-height":1e3,style:{width:"800px"},onSortChange:z.sortChange},{default:(0,a.w5)((()=>[(0,a.Wm)(T,{label:"序号",width:"60px",align:"center"},{default:(0,a.w5)((e=>[(0,a.Uk)((0,o.zw)(e.$index+(A.listPagination.pageIndex-1)*A.listPagination.pageSize+1),1)])),_:1}),(0,a.Wm)(T,{prop:"title",label:"章节目录",minWidth:"160px",align:"left"},{default:(0,a.w5)((({row:e})=>[(0,a._)("span",{class:"link-type",onClick:t=>z.readArticle(e)},(0,o.zw)(e.title),9,C)])),_:1}),(0,a.Wm)(T,{label:"操作",align:"center",width:"120","class-name":"small-padding fixed-width"},{default:(0,a.w5)((({row:e})=>[(0,a.Wm)(R,{type:"primary",size:"small",onClick:t=>z.readArticle(e)},{default:(0,a.w5)((()=>[L])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onSortChange"])),(0,a.wy)((0,a.Wm)(q,{total:A.total,autoScroll:!1,page:A.listPagination.pageIndex,"onUpdate:page":t[3]||(t[3]=e=>A.listPagination.pageIndex=e),limit:A.listPagination.pageSize,"onUpdate:limit":t[4]||(t[4]=e=>A.listPagination.pageSize=e),onPagination:z.getList},null,8,["total","page","limit","onPagination"]),[[s.F8,A.total>0]])],512),[[s.F8,A.catalogVisible]])],512),[[s.F8,!A.inReader]]),(0,a.wy)((0,a._)("div",N,[(0,a.Wm)(F,{ref:"reader",changeMode:z.changeMode,inReader:A.inReader,bookId:A.bookId,bookName:A.bookName,articleData:A.articleData,chapterList:A.chapterList},null,8,["changeMode","inReader","bookId","bookName","articleData","chapterList"])],512),[[s.F8,A.inReader]])])}i(2801);var A=i(5691),z=i(2441),B=i(6814),S={name:"BookList",components:{Pagination:A.Z,YunReader:z.Z},data(){return{fileList:[],file:null,bookList:[],bookText:"",chapterList:[],bookName:"",bookId:"",articleData:"",listPagination:{sort:"id",sortType:"desc",pageIndex:1,pageSize:10},tableKey:0,list:[],total:0,isAsc:!0,inReader:!1,catalogVisible:!1}},mounted(){const e=[{storeName:"book",idName:"id",indexName:"bookId",propName:"bookId",unique:!0},{storeName:"brief",idName:"id",indexName:"bookId",propName:"bookId",unique:!0}];(0,B.h)("db_YunReader",1,e).then((e=>{console.log("db",e),(0,B.C)("brief","getAll").then((e=>{e&&(this.bookList=e)}))}))},methods:{extractTitles(e){const t=/(正文){0,1}(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回]((?! {4}).)((?!\t{1,4}).){0,30}\r?\n/g;let i=[],a=null;a=e.match(t),a&&i.push(...a);for(let o=0;o<i.length;o++)i[o]=i[o].replace("\r","").replace("\n","").replace("\t","");return i},getChapters(){var e=performance.now();const t=!1;this.list=[];const i=/^(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回季](.){0,30}|^【(.{1,30})】$/,a=this.bookText;let o=a.replaceAll("\r\n","\n").replaceAll("\r","\n").split("\n").map((e=>e.trim())).filter((e=>e.length>0)),s=0,n=[],l=[];for(let d=0;d<o.length;d++){if(i.test(o[d]))if(0==d)l.push(o[d]);else{const e=o.slice(s,d);0==l.length&&0==s&&l.push("前言"),l.push(o[d]),n.push(e),s=d}if(d==o.length-1){const e=o.slice(s,d+1);0==l.length&&l.push(e[0].slice(0,10)),n.push(e)}}t&&console.log("chapters",n),t&&console.log("titles",l),this.chapterList=[];for(let d=0;d<n.length;d++)this.chapterList.push({id:d,title:l[d],content:n[d]});this.updateBookList();var r=performance.now();console.log("getChapters 耗时",r-e+"ms")},updateBookList(){(0,B.C)("brief","getByIndex",{name:"bookId",value:this.bookId}).then((e=>{if(e)this.$message({message:"选择的书已在列表中",type:"info",duration:1e3});else{const e={bookId:this.bookId,bookName:this.bookName,chapterList:JSON.stringify(this.chapterList)},t={bookId:this.bookId,bookName:this.bookName};(0,B.C)("book","add",e),(0,B.C)("brief","add",t),this.bookList.push(t)}}))},readArticle(e){this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,this.$nextTick((()=>{e&&(this.$refs.reader.currentChapter=e.id)})),setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100)},readBook(e){(0,B.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{t&&(this.bookId=e.bookId,this.bookName=t.bookName,this.chapterList=JSON.parse(t.chapterList),this.listPagination.pageIndex=1,this.getList(),this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100))}))},showCatalog(e,t=!0){this.catalogVisible=t,t&&(0,B.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{t&&(this.bookId=e.bookId,this.bookName=t.bookName,this.chapterList=JSON.parse(t.chapterList),this.listPagination.pageIndex=1,this.getList())}))},deleteBook(e,t){(0,B.C)("brief","getByIndex",{name:"bookId",value:e.bookId}).then((e=>{(0,B.C)("brief","delete",e.id),(0,B.C)("book","delete",e.id).then((()=>{this.bookList.splice(t,1)}))}))},onChange(){this.$refs.upload.abort(),this.$refs.upload.clearFiles();var e=e||window.event,t=e.target.files[0];this.file=t,this.bookName=t.name.split(".").slice(0,-1).join("."),this.bookId=this.encode(this.bookName),this.beforeAnalysis(t);var i=new FileReader;i.onload=e=>{const a=e.target.result;-1===a.indexOf("�")?(this.bookText=a,this.getChapters()):i.readAsText(t,"gb2312")},i.readAsText(t)},beforeAnalysis(e){const t="text/plain"==e.type,i=e.size/1024/1024<50;return t||this.$message.error("选择的文件只能是 txt 格式!"),i||this.$message.error("选择的文件大小不能超过 50MB!"),t&&i},encode(e){let t=encodeURI(e),i=btoa(t);return i},changeMode(){this.inReader=!this.inReader},getList(){this.list=[],this.total=this.chapterList.length;const e=this.listPagination.pageIndex,t=this.listPagination.pageSize;if(this.isAsc){const i=(e-1)*t,a=i+t;for(let e=i;e<a&&e<this.total;e++)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}else{const i=this.total-1-(e-1)*t,a=i-t;for(let e=i;e>a&&e>=0;e--)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}},sortChange(){this.isAsc=!this.isAsc,this.getList(),this.listPagination.pageIndex=1},goBack(){}}},P=i(89);const R=(0,P.Z)(S,[["render",v]]);var W=R}}]);
//# sourceMappingURL=491.3f561895.js.map