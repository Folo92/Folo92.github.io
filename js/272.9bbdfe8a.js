"use strict";(self["webpackChunkyun_admin"]=self["webpackChunkyun_admin"]||[]).push([[272],{6814:function(e,t,o){o.d(t,{C:function(){return a},h:function(){return s}});o(6699),o(1703);let i;function s(e="db_default",t=1,o){return new Promise(((s,a)=>{const n=window.indexedDB.open(e,t);n.onsuccess=function(e){i=e.target.result,s(e.target.result)},n.onupgradeneeded=function(e){i=e.target.result,o&&o.forEach((e=>{if(!i.objectStoreNames.contains(e.storeName)){const t=i.createObjectStore(e.storeName,{keyPath:e.idName,autoIncrement:!0});t.createIndex(e.indexName,e.propName,{unique:e.unique})}}))},n.onerror=function(e){a(e)}}))}async function a(e,t,o){console.log(e,t,o),alert(e+","+t+","+o);const s=["add","get","getAll","put","delete","getByIndex"];if(!s.includes(t))throw new Error(`操作类型错误, 仅支持: ${s.toString()} 方法`);const a=["get","getAll","getByIndex"].includes(t)?"readonly":"readwrite",n=i.transaction(e,a).objectStore(e);return console.log("objectStore",n),alert("objectStore,",n),new Promise(((i,s)=>{let a;if("getByIndex"==t){const e=n.index(o.name);a=e.get(o.value)}else a=n[t](o);console.log("request",a),alert("request,",a),a.onsuccess=s=>{console.log(e,t,o,"success",s),alert(e+","+t+","+o+",success,",s),i(s.target.result)},a.onerror=e=>{console.log(e),s(e)}}))}window.indexedDB||window.alert("你的浏览器不支持IndexedDB的稳定版本。书籍缓存功能将不可用。")},8594:function(e,t,o){o.r(t),o.d(t,{default:function(){return $}});var i=o(3396);function s(e,t,o,s,a,n){const l=(0,i.up)("BookShelf");return(0,i.wg)(),(0,i.iD)("div",null,[(0,i.Wm)(l)])}var a=o(7139),n=o(9242);const l={class:"app-container"},r={class:"bookshelf"},d={class:"bookshelf-container"},c={class:"bookshelf-title"},h=(0,i._)("span",null,"我的书架",-1),p=(0,i.Uk)("  "),u=(0,i._)("span",{style:{right:"0"}}," 按访问时间排序",-1),m=(0,i._)("span",{style:{right:"0"}}," 按添加顺序排序",-1),k={class:"bookshelf-content"},g={class:"cover-head"},b=["src"],f=["onClick"],w=(0,i._)("br",null,null,-1),y={style:{color:"#4490f1","font-size":"16px"}},x={class:"flex items-center"},I={style:{color:"var(--el-text-color-regular)","font-size":"16px"}},_=(0,i.Uk)("   "),C=(0,i.Uk)("   "),v=(0,i._)("br",null,null,-1),L=["onClick"],N=(0,i.Uk)(" 阅读 ");function B(e,t,s,B,W,S){const T=(0,i.up)("Select"),z=(0,i.up)("el-icon"),A=(0,i.up)("MoreFilled"),P=(0,i.up)("el-popover"),R=(0,i.up)("el-input"),F=(0,i.up)("Search"),D=(0,i.up)("Plus"),$=(0,i.up)("el-button"),j=(0,i.up)("el-popconfirm"),O=(0,i.up)("el-card"),U=(0,i.up)("el-col"),M=(0,i.up)("el-row"),V=(0,i.up)("el-page-header"),q=(0,i.up)("el-table-column"),Z=(0,i.up)("el-table"),K=(0,i.up)("pagination"),E=(0,i.up)("YunReader");return(0,i.wg)(),(0,i.iD)("div",l,[(0,i.wy)((0,i._)("div",r,[(0,i._)("div",d,[(0,i._)("div",c,[h,p,(0,i.wy)((0,i._)("span",{style:{"font-size":"14px"}},"当前搜索："+(0,a.zw)(W.keyword),513),[[n.F8,W.keyword]]),(0,i.Wm)(P,{"popper-class":"popover-more",placement:"bottom-end",width:160,offset:10},{reference:(0,i.w5)((()=>[(0,i.Wm)(z,{size:20},{default:(0,i.w5)((()=>[(0,i.Wm)(A)])),_:1})])),default:(0,i.w5)((()=>[(0,i._)("div",{class:"bookshelf-menu-item",onClick:t[0]||(t[0]=e=>W.sortByTime=!0)},[(0,i.Wm)(z,{style:(0,a.j5)({top:"3px",visibility:W.sortByTime?"visible":"hidden"})},{default:(0,i.w5)((()=>[(0,i.Wm)(T)])),_:1},8,["style"]),u]),(0,i._)("div",{class:"bookshelf-menu-item",onClick:t[1]||(t[1]=e=>W.sortByTime=!1)},[(0,i.Wm)(z,{style:(0,a.j5)({top:"3px",visibility:W.sortByTime?"hidden":"visible"})},{default:(0,i.w5)((()=>[(0,i.Wm)(T)])),_:1},8,["style"]),m])])),_:1}),(0,i.Wm)(P,{"popper-class":"popover-more",placement:"bottom-end",width:200,offset:10},{reference:(0,i.w5)((()=>[(0,i.Wm)(z,{size:20},{default:(0,i.w5)((()=>[(0,i.Wm)(F)])),_:1})])),default:(0,i.w5)((()=>[(0,i.Wm)(R,{modelValue:W.searchInput,"onUpdate:modelValue":t[2]||(t[2]=e=>W.searchInput=e),placeholder:"书名搜索",clearable:"",onInput:S.inputChange},null,8,["modelValue","onInput"])])),_:1}),(0,i.Wm)(z,{size:20,onClick:S.selectFile},{default:(0,i.w5)((()=>[(0,i.Wm)(D)])),_:1},8,["onClick"])]),(0,i._)("div",k,[(0,i.Wm)(M,{gutter:30},{default:(0,i.w5)((()=>[((0,i.wg)(!0),(0,i.iD)(i.HY,null,(0,i.Ko)(S.bookListFilted,(e=>((0,i.wg)(),(0,i.j4)(U,{key:e,span:6,style:{"margin-bottom":"30px"}},{default:(0,i.w5)((()=>[(0,i.Wm)(O,{"body-style":{padding:"0px",height:"220px",position:"relative"}},{default:(0,i.w5)((()=>[(0,i._)("div",g,[(0,i.Wm)($,{text:"",icon:"Tickets",class:"cover-button",onClick:t=>S.showCatalog(e)},null,8,["onClick"]),(0,i.Wm)(j,{title:"确定删除吗?",onConfirm:t=>S.deleteBook(e)},{reference:(0,i.w5)((()=>[(0,i.Wm)($,{text:"",icon:"Delete",class:"cover-button"})])),_:2},1032,["onConfirm"])]),(0,i._)("img",{src:o(5569),class:"image"},null,8,b),(0,i._)("div",{class:"link-type book-name",onClick:t=>S.readBook(e)},(0,a.zw)(e.bookName),9,f)])),_:2},1024)])),_:2},1024)))),128)),(0,i.Wm)(U,{span:6,style:{"margin-bottom":"30px"}},{default:(0,i.w5)((()=>[(0,i.Wm)(O,{"body-style":{padding:"0px",height:"220px",position:"relative"},onClick:S.selectFile},{default:(0,i.w5)((()=>[(0,i.Wm)(z,{size:30,class:"add-book-icon"},{default:(0,i.w5)((()=>[(0,i.Wm)(D)])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1})]),w,(0,i.wy)((0,i._)("div",null,[(0,i.Wm)(V,{icon:W.isAsc?"SortUp":"SortDown",onBack:S.sortChange,style:{color:"#4490f1","font-size":"16px"}},{title:(0,i.w5)((()=>[(0,i._)("span",y,(0,a.zw)(W.isAsc?"升序":"降序"),1)])),content:(0,i.w5)((()=>[(0,i._)("div",x,[(0,i._)("span",I,(0,a.zw)(W.bookName),1),_,(0,i.wy)((0,i._)("span",{class:"link-type",style:{"font-size":"14px"},onClick:t[3]||(t[3]=e=>S.readArticle())},"继续阅读",512),[[n.F8,""!=W.bookName]]),C,(0,i._)("span",{class:"link-type",style:{"font-size":"14px",right:"0"},onClick:t[4]||(t[4]=e=>W.catalogVisible=!1)},"关闭")])])),_:1},8,["icon","onBack"]),v,((0,i.wg)(),(0,i.j4)(Z,{key:W.tableKey,data:W.list,border:"","table-layout":"fixed","max-height":1e3,style:{width:"840px"},onSortChange:S.sortChange},{default:(0,i.w5)((()=>[(0,i.Wm)(q,{label:"序号",width:"60px",align:"center"},{default:(0,i.w5)((e=>[(0,i.Uk)((0,a.zw)(e.$index+(W.listPagination.pageIndex-1)*W.listPagination.pageSize+1),1)])),_:1}),(0,i.Wm)(q,{prop:"title",label:"章节目录",minWidth:"160px",align:"left"},{default:(0,i.w5)((({row:e})=>[(0,i._)("span",{class:"link-type",onClick:t=>S.readArticle(e)},(0,a.zw)(e.title),9,L)])),_:1}),(0,i.Wm)(q,{label:"操作",align:"center",width:"120","class-name":"small-padding fixed-width"},{default:(0,i.w5)((({row:e})=>[(0,i.Wm)($,{type:"primary",size:"small",onClick:t=>S.readArticle(e)},{default:(0,i.w5)((()=>[N])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onSortChange"])),(0,i.wy)((0,i.Wm)(K,{total:W.total,autoScroll:!1,page:W.listPagination.pageIndex,"onUpdate:page":t[5]||(t[5]=e=>W.listPagination.pageIndex=e),limit:W.listPagination.pageSize,"onUpdate:limit":t[6]||(t[6]=e=>W.listPagination.pageSize=e),onPagination:S.getList},null,8,["total","page","limit","onPagination"]),[[n.F8,W.total>0]])],512),[[n.F8,W.catalogVisible]])])],512),[[n.F8,!W.inReader]]),(0,i.wy)((0,i.Wm)(E,{ref:"reader",changeMode:S.changeMode,inReader:W.inReader,bookId:W.bookId,bookName:W.bookName,chapterList:W.chapterList,articleData:W.articleData},null,8,["changeMode","inReader","bookId","bookName","chapterList","articleData"]),[[n.F8,W.inReader]])])}o(2801);var W=o(5691),S=o(2441),T=o(6814),z={name:"BookShelf",components:{Pagination:W.Z,YunReader:S.Z},data(){return{fileList:[],bookList:[],sortByTime:!0,searchInput:"",searchTimer:null,keyword:"",bookText:"",chapterList:[],bookName:"",bookId:"",articleData:"",listPagination:{sort:"id",sortType:"desc",pageIndex:1,pageSize:10},tableKey:0,list:[],total:0,isAsc:!0,inReader:!1,catalogVisible:!1}},mounted(){const e=[{storeName:"book",idName:"id",indexName:"bookId",propName:"bookId",unique:!0},{storeName:"brief",idName:"id",indexName:"bookId",propName:"bookId",unique:!0}];(0,T.h)("db_YunReader",1,e).then((e=>{console.log("db",e),(0,T.C)("brief","getAll").then((e=>{e&&(this.bookList=e)}))}))},methods:{extractTitles(e){const t=/(正文){0,1}(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回]((?! {4}).)((?!\t{1,4}).){0,30}\r?\n/g;let o=[],i=null;i=e.match(t),i&&o.push(...i);for(let s=0;s<o.length;s++)o[s]=o[s].replace("\r","").replace("\n","").replace("\t","");return o},getChapters(){var e=performance.now();const t=!1;this.list=[];const o=/^(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回季](.){0,30}|^【(.{1,30})】$/,i=this.bookText;let s=i.replaceAll("\r\n","\n").replaceAll("\r","\n").split("\n").map((e=>e.trim())).filter((e=>e.length>0)),a=0,n=[],l=[];for(let d=0;d<s.length;d++){if(o.test(s[d]))if(0==d)l.push(s[d]);else{const e=s.slice(a,d);0==l.length&&0==a&&l.push("前言"),l.push(s[d]),n.push(e),a=d}if(d==s.length-1){const e=s.slice(a,d+1);0==l.length&&l.push(e[0].slice(0,10)),n.push(e)}}t&&console.log("chapters",n),t&&console.log("titles",l),this.chapterList=[];for(let d=0;d<n.length;d++)this.chapterList.push({id:d,title:l[d],content:n[d]});this.updateBookList();var r=performance.now();console.log("getChapters 耗时",r-e+"ms")},updateBookList(){(0,T.C)("brief","getByIndex",{name:"bookId",value:this.bookId}).then((e=>{if(e)this.$message({message:"选择的书已在列表中",type:"info",duration:1e3});else{const e={bookId:this.bookId,bookName:this.bookName,chapterList:JSON.stringify(this.chapterList)},t={bookId:this.bookId,bookName:this.bookName,accessTime:new Date};(0,T.C)("book","add",e),(0,T.C)("brief","add",t),this.bookList.push(t)}}))},readArticle(e){this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,this.$nextTick((()=>{e&&(this.$refs.reader.currentChapter=e.id)})),setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100)},readBook(e){(0,T.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{t&&((0,T.C)("brief","put",{id:e.id,bookId:e.bookId,bookName:e.bookName,accessTime:new Date}),e.accessTime=new Date,this.bookId=e.bookId,this.bookName=t.bookName,this.chapterList=JSON.parse(t.chapterList),this.listPagination.pageIndex=1,this.getList(),this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100))}))},showCatalog(e,t=!0){this.catalogVisible=t,t&&(0,T.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((e=>{e&&(this.bookId=e.bookId,this.bookName=e.bookName,this.chapterList=JSON.parse(e.chapterList),this.listPagination.pageIndex=1,this.getList())}))},deleteBook(e){(0,T.C)("brief","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{localStorage.removeItem("LASTPOSITION_"+e.bookId),localStorage.removeItem("BOOKMARKS_"+e.bookId),(0,T.C)("brief","delete",t.id),(0,T.C)("book","delete",t.id).then((()=>{let t=0;for(let o in this.bookList)if(this.bookList[o].id==e.id){t=o;break}this.bookList.splice(t,1)}))}))},selectFile(){if(!window.FileReader)return void alert("浏览器不支持浏览本地文件！");let e=document.getElementsByClassName("_add-book-file")[0];e||(e=document.createElement("input"),e.setAttribute("class","_add-book-file"),e.setAttribute("type","file"),e.setAttribute("style","display:none"),document.body.appendChild(e),e.onchange=()=>{this.readFile(e)}),e.click(),e.value},readFile(e){let t=e.files[0];if(document.body.removeChild(e),!t)return;this.bookName=t.name.split(".").slice(0,-1).join("."),this.bookId=this.encode(this.bookName),this.checkFile(t);let o=new FileReader;o.onload=e=>{const i=e.target.result;-1===i.indexOf("�")?(this.bookText=i,this.getChapters()):o.readAsText(t,"gb2312")},o.readAsText(t)},checkFile(e){const t="text/plain"==e.type,o=e.size/1024/1024<50;return t||this.$message.error("选择的文件只能是 txt 格式!"),o||this.$message.error("选择的文件大小不能超过 50MB!"),t&&o},encode(e){let t=encodeURI(e),o=btoa(t);return o},changeMode(){this.inReader=!this.inReader},getList(){this.list=[],this.total=this.chapterList.length;const e=this.listPagination.pageIndex,t=this.listPagination.pageSize;if(this.isAsc){const o=(e-1)*t,i=o+t;for(let e=o;e<i&&e<this.total;e++)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}else{const o=this.total-1-(e-1)*t,i=o-t;for(let e=o;e>i&&e>=0;e--)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}},sortChange(){this.isAsc=!this.isAsc,this.getList(),this.listPagination.pageIndex=1},inputChange(e){clearTimeout(this.searchTimer),this.searchTimer=setTimeout((()=>{this.keyword=e}),500)}},computed:{bookListFilted(){const e=this.bookList.filter((e=>""==this.keyword||e.bookName.indexOf(this.keyword)>-1));return e.sort(((e,t)=>this.sortByTime?t.accessTime-e.accessTime:e.id-t.id)),e}}},A=o(89);const P=(0,A.Z)(z,[["render",B]]);var R=P,F={name:"MyBookShelf",components:{BookShelf:R}};const D=(0,A.Z)(F,[["render",s]]);var $=D},5569:function(e,t,o){e.exports=o.p+"img/cover01.5e5f913a.jpg"}}]);
//# sourceMappingURL=272.9bbdfe8a.js.map