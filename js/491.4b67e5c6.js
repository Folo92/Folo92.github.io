"use strict";(self["webpackChunkyun_admin"]=self["webpackChunkyun_admin"]||[]).push([[491],{6814:function(e,t,i){i.d(t,{C:function(){return s},h:function(){return a}});i(6699),i(1703);let o;function a(e="db_default",t=1,i){return new Promise(((a,s)=>{const n=window.indexedDB.open(e,t);n.onsuccess=function(e){o=e.target.result,a(e.target.result)},n.onupgradeneeded=function(e){o=e.target.result,i&&i.forEach((e=>{if(!o.objectStoreNames.contains(e.storeName)){const t=o.createObjectStore(e.storeName,{keyPath:e.idName,autoIncrement:!0});t.createIndex(e.indexName,e.propName,{unique:e.unique})}}))},n.onerror=function(e){s(e)}}))}async function s(e,t,i){const a=["add","get","getAll","put","delete","getByIndex"];if(!a.includes(t))throw new Error(`操作类型错误, 仅支持: ${a.toString()} 方法`);const s=["get","getAll","getByIndex"].includes(t)?"readonly":"readwrite",n=o.transaction(e,s).objectStore(e);return new Promise(((e,o)=>{let a;if("getByIndex"==t){const e=n.index(i.name);a=e.get(i.value)}else a=n[t](i);a.onsuccess=t=>{e(t.target.result)},a.onerror=e=>{o(e)}}))}window.indexedDB||window.alert("你的浏览器不支持IndexedDB的稳定版本。书籍缓存功能将不可用。")},7281:function(e,t,i){i.r(t),i.d(t,{default:function(){return W}});var o=i(3396),a=i(7139),s=i(9242);const n={class:"app-container"},l={style:{width:"800px",margin:"0 auto"}},r=(0,o._)("div",{class:"el-upload__text"},[(0,o.Uk)("Drop file here or "),(0,o._)("em",null,"click to upload")],-1),d=(0,o._)("div",{class:"el-upload__tip"},"txt files with a size less than 50mb",-1),c=(0,o._)("br",null,null,-1),h=(0,o._)("img",{src:"https://img.fevte.com/data/attachment/portal/201407/31/112644t4u445t4ttch57mu.jpg?x-oss-process=image/auto-orient,1/quality,q_80",class:"image"},null,-1),p={style:{padding:"14px"}},u=["onClick"],g={class:"bottom"},k=(0,o.Uk)("目录"),m=(0,o.Uk)("删除"),b=(0,o._)("br",null,null,-1),f={style:{color:"#4490f1","font-size":"16px"}},w={class:"flex items-center"},x={style:{color:"var(--el-text-color-regular)","font-size":"16px"}},y=(0,o.Uk)("   "),I=(0,o.Uk)("   "),_=(0,o._)("br",null,null,-1),C=["onClick"],L=(0,o.Uk)(" 阅读 "),N={class:"filter-container"};function v(e,t,i,v,z,A){const B=(0,o.up)("upload-filled"),P=(0,o.up)("el-icon"),R=(0,o.up)("el-upload"),S=(0,o.up)("el-button"),W=(0,o.up)("el-card"),$=(0,o.up)("el-col"),U=(0,o.up)("el-row"),D=(0,o.up)("el-page-header"),T=(0,o.up)("el-table-column"),j=(0,o.up)("el-table"),F=(0,o.up)("pagination"),V=(0,o.up)("YunReader");return(0,o.wg)(),(0,o.iD)("div",n,[(0,o.wy)((0,o._)("div",l,[(0,o.Wm)(R,{modelValue:z.fileList,"onUpdate:modelValue":t[0]||(t[0]=e=>z.fileList=e),ref:"upload",class:"upload-demo",action:"#","auto-upload":!1,drag:"","on-change":A.onChange},{tip:(0,o.w5)((()=>[d])),default:(0,o.w5)((()=>[(0,o.Wm)(P,{class:"el-icon--upload"},{default:(0,o.w5)((()=>[(0,o.Wm)(B)])),_:1}),r])),_:1},8,["modelValue","on-change"]),c,(0,o.Wm)(U,{gutter:30},{default:(0,o.w5)((()=>[((0,o.wg)(!0),(0,o.iD)(o.HY,null,(0,o.Ko)(z.bookList,((e,t)=>((0,o.wg)(),(0,o.j4)($,{key:e,span:6,style:{"margin-bottom":"30px"}},{default:(0,o.w5)((()=>[(0,o.Wm)(W,{"body-style":{padding:"0px",height:"240px"}},{default:(0,o.w5)((()=>[h,(0,o._)("div",p,[(0,o._)("div",{class:"link-type",style:{"font-size":"14px",height:"50px"},onClick:t=>A.readBook(e)},(0,a.zw)(e.bookName),9,u),(0,o._)("div",g,[(0,o.Wm)(S,{text:"",class:"button link-type",onClick:t=>A.showCatalog(e)},{default:(0,o.w5)((()=>[k])),_:2},1032,["onClick"]),(0,o.Wm)(S,{text:"",class:"button link-type",onClick:i=>A.deleteBook(e,t)},{default:(0,o.w5)((()=>[m])),_:2},1032,["onClick"])])])])),_:2},1024)])),_:2},1024)))),128))])),_:1}),b,(0,o.wy)((0,o._)("div",null,[(0,o.Wm)(D,{icon:z.isAsc?"SortUp":"SortDown",onBack:A.sortChange,style:{color:"#4490f1","font-size":"16px"}},{title:(0,o.w5)((()=>[(0,o._)("span",f,(0,a.zw)(z.isAsc?"升序":"降序"),1)])),content:(0,o.w5)((()=>[(0,o._)("div",w,[(0,o._)("span",x,(0,a.zw)(z.bookName),1),y,(0,o.wy)((0,o._)("span",{class:"link-type",style:{"font-size":"14px"},onClick:t[1]||(t[1]=e=>A.readArticle())},"继续阅读",512),[[s.F8,""!=z.bookName]]),I,(0,o._)("span",{class:"link-type",style:{"font-size":"14px",right:"0"},onClick:t[2]||(t[2]=e=>z.catalogVisible=!1)},"关闭")])])),_:1},8,["icon","onBack"]),_,((0,o.wg)(),(0,o.j4)(j,{key:z.tableKey,data:z.list,border:"","table-layout":"fixed","max-height":1e3,style:{width:"800px"},onSortChange:A.sortChange},{default:(0,o.w5)((()=>[(0,o.Wm)(T,{label:"序号",width:"60px",align:"center"},{default:(0,o.w5)((e=>[(0,o.Uk)((0,a.zw)(e.$index+(z.listPagination.pageIndex-1)*z.listPagination.pageSize+1),1)])),_:1}),(0,o.Wm)(T,{prop:"title",label:"章节目录",minWidth:"160px",align:"left"},{default:(0,o.w5)((({row:e})=>[(0,o._)("span",{class:"link-type",onClick:t=>A.readArticle(e)},(0,a.zw)(e.title),9,C)])),_:1}),(0,o.Wm)(T,{label:"操作",align:"center",width:"120","class-name":"small-padding fixed-width"},{default:(0,o.w5)((({row:e})=>[(0,o.Wm)(S,{type:"primary",size:"small",onClick:t=>A.readArticle(e)},{default:(0,o.w5)((()=>[L])),_:2},1032,["onClick"])])),_:1})])),_:1},8,["data","onSortChange"])),(0,o.wy)((0,o.Wm)(F,{total:z.total,autoScroll:!1,page:z.listPagination.pageIndex,"onUpdate:page":t[3]||(t[3]=e=>z.listPagination.pageIndex=e),limit:z.listPagination.pageSize,"onUpdate:limit":t[4]||(t[4]=e=>z.listPagination.pageSize=e),onPagination:A.getList},null,8,["total","page","limit","onPagination"]),[[s.F8,z.total>0]])],512),[[s.F8,z.catalogVisible]])],512),[[s.F8,!z.inReader]]),(0,o.wy)((0,o._)("div",N,[(0,o.Wm)(V,{ref:"reader",changeMode:A.changeMode,inReader:z.inReader,bookId:z.bookId,bookName:z.bookName,articleData:z.articleData,chapterList:z.chapterList},null,8,["changeMode","inReader","bookId","bookName","articleData","chapterList"])],512),[[s.F8,z.inReader]])])}i(2801);var z=i(5691),A=i(2441),B=i(6814),P={name:"BookList",components:{Pagination:z.Z,YunReader:A.Z},data(){return{fileList:[],file:null,bookList:[],bookText:"",chapterList:[],bookName:"",bookId:"",articleData:"",listPagination:{sort:"id",sortType:"desc",pageIndex:1,pageSize:10},tableKey:0,list:[],total:0,isAsc:!0,inReader:!1,catalogVisible:!1}},mounted(){const e=[{storeName:"book",idName:"id",indexName:"bookId",propName:"bookId",unique:!0},{storeName:"brief",idName:"id",indexName:"bookId",propName:"bookId",unique:!0}];(0,B.h)("db_YunReader",1,e).then((e=>{console.log("db",e),(0,B.C)("brief","getAll").then((e=>{e&&(this.bookList=e)}))}))},methods:{extractTitles(e){const t=/(正文){0,1}(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回]((?! {4}).)((?!\t{1,4}).){0,30}\r?\n/g;let i=[],o=null;o=e.match(t),o&&i.push(...o);for(let a=0;a<i.length;a++)i[a]=i[a].replace("\r","").replace("\n","").replace("\t","");return i},getChapters(){var e=performance.now();const t=!1;this.list=[];const i=/^(第)([零〇一二三四五六七八九十百千万a-zA-Z0-9]{1,7})[章节卷集部篇回季](.){0,30}|^【(.{1,30})】$/,o=this.bookText;let a=o.replaceAll("\r\n","\n").replaceAll("\r","\n").split("\n").map((e=>e.trim())).filter((e=>e.length>0)),s=0,n=[],l=[];for(let d=0;d<a.length;d++){if(i.test(a[d]))if(0==d)l.push(a[d]);else{const e=a.slice(s,d);0==l.length&&0==s&&l.push("前言"),l.push(a[d]),n.push(e),s=d}if(d==a.length-1){const e=a.slice(s,d+1);0==l.length&&l.push(e[0].slice(0,10)),n.push(e)}}t&&console.log("chapters",n),t&&console.log("titles",l),this.chapterList=[];for(let d=0;d<n.length;d++)this.chapterList.push({id:d,title:l[d],content:n[d]});this.updateBookList();var r=performance.now();console.log("getChapters 耗时",r-e+"ms")},updateBookList(){(0,B.C)("brief","getByIndex",{name:"bookId",value:this.bookId}).then((e=>{if(e)this.$message({message:"选择的书已在列表中",type:"info",duration:1e3});else{const e={bookId:this.bookId,bookName:this.bookName,chapterList:JSON.stringify(this.chapterList)},t={bookId:this.bookId,bookName:this.bookName};(0,B.C)("book","add",e),(0,B.C)("brief","add",t),this.bookList.push(t)}}))},readArticle(e){this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,this.$nextTick((()=>{e&&(this.$refs.reader.currentChapter=e.id)})),setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100)},readBook(e){(0,B.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{t&&(this.bookId=e.bookId,this.bookName=t.bookName,this.chapterList=JSON.parse(t.chapterList),this.listPagination.pageIndex=1,this.getList(),this.$refs.reader.turnLocked=!0,this.inReader=!this.inReader,setTimeout((()=>{this.$refs.reader.turnLocked=!1}),100))}))},showCatalog(e,t=!0){this.catalogVisible=t,t&&(0,B.C)("book","getByIndex",{name:"bookId",value:e.bookId}).then((t=>{t&&(this.bookId=e.bookId,this.bookName=t.bookName,this.chapterList=JSON.parse(t.chapterList),this.listPagination.pageIndex=1,this.getList())}))},deleteBook(e,t){(0,B.C)("brief","getByIndex",{name:"bookId",value:e.bookId}).then((e=>{(0,B.C)("brief","delete",e.id),(0,B.C)("book","delete",e.id).then((()=>{this.bookList.splice(t,1)}))}))},onChange(){this.$refs.upload.abort(),this.$refs.upload.clearFiles();var e=e||window.event,t=e.target.files[0];this.file=t,this.bookName=t.name.split(".").slice(0,-1).join("."),this.bookId=this.encode(this.bookName),this.beforeAnalysis(t);var i=new FileReader;i.onload=e=>{const o=e.target.result;-1===o.indexOf("�")?(this.bookText=o,this.getChapters()):i.readAsText(t,"gb2312")},i.readAsText(t)},beforeAnalysis(e){const t="text/plain"==e.type,i=e.size/1024/1024<50;return t||this.$message.error("选择的文件只能是 txt 格式!"),i||this.$message.error("选择的文件大小不能超过 50MB!"),t&&i},encode(e){let t=encodeURI(e),i=btoa(t);return i},changeMode(){this.inReader=!this.inReader},getList(){this.list=[],this.total=this.chapterList.length;const e=this.listPagination.pageIndex,t=this.listPagination.pageSize;if(this.isAsc){const i=(e-1)*t,o=i+t;for(let e=i;e<o&&e<this.total;e++)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}else{const i=this.total-1-(e-1)*t,o=i-t;for(let e=i;e>o&&e>=0;e--)this.list.push({id:this.chapterList[e].id,title:this.chapterList[e].title})}},sortChange(){this.isAsc=!this.isAsc,this.getList(),this.listPagination.pageIndex=1},goBack(){}}},R=i(89);const S=(0,R.Z)(P,[["render",v]]);var W=S}}]);
//# sourceMappingURL=491.4b67e5c6.js.map